<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archiviste - GEOPOL</title>
    <!-- Remplacer le CDN Tailwind par la version production -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-gray-50">
    <!-- Le reste de votre archiviste.html existant reste inchang√© -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- En-t√™te -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-archive text-amber-600 mr-3"></i>
                            Archiviste Historique
                        </h1>
                        <p class="text-gray-600">
                            Analyse historique depuis 1945 via Archive.org
                        </p>
                    </div>
                    <a href="/" class="text-amber-600 hover:text-amber-800">
                        <i class="fas fa-arrow-left mr-2"></i>Retour
                    </a>
                </div>
            </div>

            <!-- Explication -->
            <div class="bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-amber-500 p-4 rounded-lg mb-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-archive text-amber-500 text-2xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-semibold text-gray-800">Analyse Historique depuis 1945</h3>
                        <p class="mt-2 text-sm text-gray-600">
                            Comparez les tendances √©motionnelles et th√©matiques actuelles avec celles du pass√©.
                            D√©couvrez l'√©volution des mentalit√©s sur 80 ans d'histoire.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Actions principales -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="font-bold text-gray-800 mb-3">
                        <i class="fas fa-search text-amber-600 mr-2"></i>
                        Analyse de P√©riode
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Analyser une p√©riode historique sp√©cifique</p>
                    <button onclick="showPeriodAnalysisForm()"
                            class="w-full bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700 transition">
                        <i class="fas fa-search mr-2"></i>Analyser
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="font-bold text-gray-800 mb-3">
                        <i class="fas fa-balance-scale text-orange-600 mr-2"></i>
                        Comparaison Temporelle
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Comparer maintenant avec le pass√©</p>
                    <button onclick="compareWithHistory()"
                            class="w-full bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 transition">
                        <i class="fas fa-balance-scale mr-2"></i>Comparer
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="font-bold text-gray-800 mb-3">
                        <i class="fas fa-chart-line text-red-600 mr-2"></i>
                        √âvolution des Tendances
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Voir l'√©volution des tendances</p>
                    <button onclick="showTrendsEvolution()"
                            class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                        <i class="fas fa-chart-line mr-2"></i>Voir
                    </button>
                </div>
            </div>

            <!-- Zone de r√©sultats pour l'analyse de p√©riode -->
            <div id="period-result" class="mb-6"></div>

            <!-- Zone de r√©sultats pour la comparaison historique -->
            <div id="history-comparison-result" class="mb-6"></div>

            <!-- Zone de r√©sultats pour l'√©volution des tendances -->
            <div id="trends-evolution-result" class="mb-6"></div>

            <!-- Informations sur Archive.org -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                    <div>
                        <h5 class="font-semibold text-blue-800">Donn√©es Source</h5>
                        <p class="text-sm text-blue-600">
                            Les analyses sont bas√©es sur les archives de
                            <a href="https://archive.org" target="_blank" class="underline">Archive.org</a>
                            incluant journaux, magazines et livres depuis 1945.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/archiviste.js') }}"></script>
    <script>
        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üìö Page Archiviste initialis√©e');
        });

        async function showPeriodAnalysisForm() {
            const resultDiv = document.getElementById('period-result');
            resultDiv.innerHTML = `
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="font-bold text-gray-800 mb-4">
                                <i class="fas fa-search text-amber-600 mr-2"></i>
                                Analyse de P√©riode Historique
                            </h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">P√©riode historique</label>
                                    <select id="periodSelect" class="w-full p-2 border border-gray-300 rounded-lg">
                                        <option value="">Chargement...</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Th√®me d'analyse (optionnel)</label>
                                    <select id="themeSelect" class="w-full p-2 border border-gray-300 rounded-lg">
                                        <option value="">Tous les th√®mes</option>
                                    </select>
                                </div>
                            </div>

                            <button onclick="launchAnalysis()"
                                    id="launchAnalysisBtn"
                                    class="bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700 transition">
                                <i class="fas fa-play mr-2"></i>Lancer l'analyse
                            </button>

                            <div id="analysis-result" class="mt-4"></div>
                        </div>
                    `;

            // Charger les options
            await loadPeriodOptions();
        }

        async function loadPeriodOptions() {
            try {
                const response = await fetch('/api/archiviste/periods');
                const data = await response.json();

                if (data.success) {
                    const periodSelect = document.getElementById('periodSelect');
                    const themeSelect = document.getElementById('themeSelect');

                    if (periodSelect) {
                        periodSelect.innerHTML = '<option value="">S√©lectionnez une p√©riode</option>';
                        Object.entries(data.periods).forEach(([key, period]) => {
                            periodSelect.innerHTML += `
                                        <option value="${key}">
                                            ${period.name} (${period.start.slice(0, 4)}-${period.end.slice(0, 4)})
                                        </option>
                                    `;
                        });
                    }

                    if (themeSelect) {
                        themeSelect.innerHTML = '<option value="">Tous les th√®mes</option>';
                        data.themes.forEach(theme => {
                            themeSelect.innerHTML += `
                                        <option value="${theme}">
                                            ${theme.charAt(0).toUpperCase() + theme.slice(1)}
                                        </option>
                                    `;
                        });
                    }
                }
            } catch (error) {
                console.error('Erreur chargement options:', error);
            }
        }

        async function launchAnalysis() {
            const periodKey = document.getElementById('periodSelect')?.value;
            const theme = document.getElementById('themeSelect')?.value;
            const btn = document.getElementById('launchAnalysisBtn');
            const resultDiv = document.getElementById('analysis-result');

            if (!periodKey) {
                alert('Veuillez s√©lectionner une p√©riode');
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyse en cours...';
            }

            if (resultDiv) {
                resultDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-amber-600 text-xl"></i></div>';
            }

            try {
                const response = await fetch('/api/archiviste/analyze-period', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        period_key: periodKey,
                        theme: theme || null,
                        max_items: 50
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const stats = data.statistics;
                    const period = data.period;

                    if (resultDiv) {
                        resultDiv.innerHTML = `
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
                                        <div class="mb-3">
                                            <p class="font-bold text-green-800 text-lg">
                                                ‚úÖ Analyse termin√©e : ${period.name}
                                            </p>
                                            <p class="text-sm text-green-700">
                                                ${period.start} √† ${period.end} ‚Ä¢ ${data.items_analyzed} articles analys√©s
                                            </p>
                                        </div>

                                        <div class="grid grid-cols-3 gap-3 mt-3">
                                            <div class="text-center p-3 bg-green-100 rounded">
                                                <div class="text-2xl font-bold text-green-700">${stats.sentiment_distribution.positive}</div>
                                                <div class="text-xs text-green-600">Positifs (${stats.sentiment_distribution.positive_percent}%)</div>
                                            </div>
                                            <div class="text-center p-3 bg-red-100 rounded">
                                                <div class="text-2xl font-bold text-red-700">${stats.sentiment_distribution.negative}</div>
                                                <div class="text-xs text-red-600">N√©gatifs (${stats.sentiment_distribution.negative_percent}%)</div>
                                            </div>
                                            <div class="text-center p-3 bg-gray-100 rounded">
                                                <div class="text-2xl font-bold text-gray-700">${stats.sentiment_distribution.neutral}</div>
                                                <div class="text-xs text-gray-600">Neutres (${stats.sentiment_distribution.neutral_percent}%)</div>
                                            </div>
                                        </div>

                                        <div class="mt-3 p-3 bg-blue-100 rounded">
                                            <p class="text-sm font-semibold text-blue-800">Sentiment moyen : ${stats.average_sentiment_score.toFixed(3)}</p>
                                            <p class="text-xs text-blue-600">Intensit√© √©motionnelle : ${stats.emotional_intensity}</p>
                                        </div>
                                    </div>
                                `;
                    }
                } else {
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
                                        <p class="text-red-800">‚ùå ${data.error || 'Erreur lors de l\'analyse'}</p>
                                    </div>
                                `;
                    }
                }
            } catch (error) {
                if (resultDiv) {
                    resultDiv.innerHTML = `
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
                                    <p class="text-red-800">‚ùå Erreur r√©seau: ${error.message}</p>
                                </div>
                            `;
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play mr-2"></i>Lancer l\'analyse';
                }
            }
        }

        async function compareWithHistory() {
            const resultDiv = document.getElementById('history-comparison-result');

            if (resultDiv) {
                resultDiv.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-orange-600 text-2xl"></i></div>';
            }

            try {
                // G√©n√©rer analyse actuelle
                const currentResponse = await fetch('/api/archiviste/current-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days: 30 })
                });

                const currentData = await currentResponse.json();

                if (currentData.success) {
                    // Comparer
                    const compareResponse = await fetch('/api/archiviste/compare-eras', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            current_analysis: currentData.current_analysis,
                            historical_periods: ['1990-2000', '2000-2010', '2010-2020', '2020-2025']
                        })
                    });

                    const compareData = await compareResponse.json();

                    if (compareData.success && resultDiv) {
                        const synthesis = compareData.synthesis || {};
                        resultDiv.innerHTML = `
                                    <div class="bg-white rounded-lg shadow-md p-6">
                                        <h3 class="font-bold text-gray-800 mb-4">
                                            <i class="fas fa-balance-scale text-orange-600 mr-2"></i>
                                            Comparaison Temporelle
                                        </h3>
                                        <div class="bg-green-50 border border-green-200 rounded p-4">
                                            <p class="text-green-800 font-semibold">
                                                ‚úÖ ${compareData.historical_periods_analyzed || 0} p√©riodes historiques analys√©es
                                            </p>
                                            <p class="text-sm text-green-700 mt-2">
                                                Score de similarit√© moyen : ${((synthesis.average_similarity_score || 0) * 100).toFixed(1)}%
                                            </p>
                                        </div>
                                    </div>
                                `;
                    }
                } else {
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                        <p class="text-red-800">‚ùå ${currentData.error || 'Erreur lors de la comparaison'}</p>
                                    </div>
                                `;
                    }
                }
            } catch (error) {
                if (resultDiv) {
                    resultDiv.innerHTML = `
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <p class="text-red-800">‚ùå Erreur: ${error.message}</p>
                                </div>
                            `;
                }
            }
        }

        async function showTrendsEvolution() {
            const resultDiv = document.getElementById('trends-evolution-result');

            if (resultDiv) {
                resultDiv.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-red-600 text-2xl"></i></div>';
            }

            try {
                const response = await fetch('/api/archiviste/trends-evolution');
                const data = await response.json();

                if (data.success && data.trends && data.trends.length > 0 && resultDiv) {
                    resultDiv.innerHTML = `
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-gray-800 mb-4">
                                        <i class="fas fa-chart-line text-red-600 mr-2"></i>
                                        √âvolution des Tendances
                                    </h3>
                                    <div class="space-y-2">
                                        ${data.trends.map(trend => `
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100 transition">
                                                <div>
                                                    <p class="font-medium text-gray-800">${trend.period_name}</p>
                                                    <p class="text-sm text-gray-600">
                                                        ${trend.total_items} articles ‚Ä¢ ${trend.emotional_intensity}
                                                    </p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-lg font-bold text-blue-600">${trend.avg_sentiment_score.toFixed(3)}</p>
                                                    <p class="text-xs text-gray-500">${new Date(trend.created_at).toLocaleDateString()}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                } else if (resultDiv) {
                    resultDiv.innerHTML = `
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-chart-line text-3xl mb-3"></i>
                                    <p>Aucune donn√©e d'√©volution disponible</p>
                                    <p class="text-sm mt-2">Effectuez d'abord des analyses historiques</p>
                                </div>
                            `;
                }
            } catch (error) {
                if (resultDiv) {
                    resultDiv.innerHTML = `
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <p class="text-red-800">‚ùå Erreur: ${error.message}</p>
                                </div>
                            `;
                }
            }
        }
    </script>
</body>
</html>