{% extends "base.html" %}

{% block title %}Archiviste - GEOPOL{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Archiviste</h1>
        <p class="text-gray-600">Analyse historique et comparaison temporelle</p>
    </div>

    <!-- Interface principale -->
    <div id="archivisteInterface">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-archive text-amber-600 mr-2"></i>
                    Analyse Historique
                </h2>
                <button onclick="loadArchivisteManager()" 
                        class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700">
                    <i class="fas fa-cog mr-2"></i>Ouvrir le gestionnaire
                </button>
            </div>
            
            <p class="text-gray-600 mb-6">
                Comparez les tendances actuelles avec les périodes historiques depuis 1945.
                Analyse basée sur les archives de <a href="https://archive.org" target="_blank" class="text-blue-600 hover:underline">Archive.org</a>.
            </p>

            <!-- Actions rapides -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="analyzeHistoricalPeriod()" 
                        class="bg-amber-600 text-white px-4 py-3 rounded-lg hover:bg-amber-700 flex items-center justify-center">
                    <i class="fas fa-search mr-2"></i>Analyse de période
                </button>
                <button onclick="compareWithHistory()" 
                        class="bg-orange-600 text-white px-4 py-3 rounded-lg hover:bg-orange-700 flex items-center justify-center">
                    <i class="fas fa-balance-scale mr-2"></i>Comparer avec l'histoire
                </button>
                <button onclick="showTrendsEvolution()" 
                        class="bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 flex items-center justify-center">
                    <i class="fas fa-chart-line mr-2"></i>Évolution des tendances
                </button>
            </div>
        </div>

        <!-- Résultats -->
        <div id="archivisteResults" class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Résultats</h3>
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-archive text-3xl mb-3"></i>
                <p>Aucune analyse historique effectuée</p>
                <p class="text-sm mt-2">Utilisez les boutons ci-dessus pour explorer l'histoire</p>
            </div>
        </div>
    </div>
</div>

<script>
// Fonctions pour l'interface archiviste
function loadArchivisteManager() {
    if (typeof ArchivisteManager !== 'undefined') {
        ArchivisteManager.showArchivistePanel();
    } else {
        console.error('ArchivisteManager non disponible');
        alert('Le gestionnaire archiviste n\'est pas disponible. Vérifiez la console pour les erreurs.');
    }
}

async function analyzeHistoricalPeriod() {
    const resultsDiv = document.getElementById('archivisteResults');
    resultsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-amber-600 text-xl"></i></div>';
    
    try {
        // Charger les périodes disponibles
        const periodsResponse = await fetch('/api/archiviste/periods');
        const periodsData = await periodsResponse.json();
        
        if (periodsData.success) {
            // Utiliser une période par défaut (années 90)
            const response = await fetch('/api/archiviste/analyze-period', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    period_key: '1990-2000',
                    max_items: 50
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                resultsDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="font-semibold text-green-800">Analyse historique terminée</p>
                        <p class="text-sm text-green-600">${data.items_analyzed} articles analysés pour ${data.period.name}</p>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-800">Erreur: ${data.error}</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800">Erreur: ${error.message}</p>
            </div>
        `;
    }
}

async function compareWithHistory() {
    const resultsDiv = document.getElementById('archivisteResults');
    resultsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-orange-600 text-xl"></i></div>';
    
    try {
        const response = await fetch('/api/archiviste/compare-eras', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                historical_periods: ['1990-2000', '2000-2010', '2010-2020']
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const synthesis = data.synthesis;
            resultsDiv.innerHTML = `
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <h4 class="font-bold text-orange-800 mb-2">Comparaison historique terminée</h4>
                    <p class="text-sm text-orange-600">
                        Score de similarité: ${(synthesis.average_similarity_score * 100).toFixed(1)}% - ${synthesis.interpretation}
                    </p>
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800">Erreur: ${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800">Erreur: ${error.message}</p>
            </div>
        `;
    }
}

async function showTrendsEvolution() {
    const resultsDiv = document.getElementById('archivisteResults');
    resultsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-red-600 text-xl"></i></div>';
    
    try {
        const response = await fetch('/api/archiviste/trends-evolution');
        const data = await response.json();
        
        if (data.success) {
            resultsDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="font-semibold text-red-800">Évolution des tendances chargée</p>
                    <p class="text-sm text-red-600">${data.trends.length} analyses historiques disponibles</p>
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800">Erreur: ${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800">Erreur: ${error.message}</p>
            </div>
        `;
    }
}

console.log('✅ Page archiviste initialisée');
</script>
{% endblock %}