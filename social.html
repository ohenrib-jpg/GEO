{% extends "base.html" %}

{% block title %}Réseaux Sociaux - GEOPOL{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Réseaux Sociaux</h1>
        <p class="text-gray-600">Analyse des tendances sur les réseaux sociaux</p>
    </div>

    <!-- Interface principale -->
    <div id="socialInterface">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-network-wired text-indigo-600 mr-2"></i>
                    Agrégation des Réseaux Sociaux
                </h2>
                <button onclick="loadSocialManager()" 
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                    <i class="fas fa-cog mr-2"></i>Ouvrir le gestionnaire
                </button>
            </div>
            
            <!-- Statistiques rapides -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="socialTotalPosts">0</div>
                    <div class="text-sm text-blue-600">Posts totaux</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="socialPositivePosts">0</div>
                    <div class="text-sm text-green-600">Sentiments positifs</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600" id="socialFactorZ">0.00</div>
                    <div class="text-sm text-purple-600">Facteur Z</div>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="fetchSocialPosts()" 
                        class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center">
                    <i class="fas fa-download mr-2"></i>Récupérer les posts
                </button>
                <button onclick="compareWithRSS()" 
                        class="bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 flex items-center justify-center">
                    <i class="fas fa-balance-scale mr-2"></i>Comparer avec RSS
                </button>
            </div>
        </div>

        <!-- Résultats -->
        <div id="socialResults" class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Résultats</h3>
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-share-alt text-3xl mb-3"></i>
                <p>Aucune action effectuée pour le moment</p>
                <p class="text-sm mt-2">Utilisez les boutons ci-dessus pour commencer l'analyse</p>
            </div>
        </div>
    </div>
</div>

<script>
// Fonctions pour l'interface sociale
function loadSocialManager() {
    if (typeof SocialAggregatorManager !== 'undefined') {
        SocialAggregatorManager.showSocialPanel();
    } else {
        console.error('SocialAggregatorManager non disponible');
        alert('Le gestionnaire social n\'est pas disponible. Vérifiez la console pour les erreurs.');
    }
}

async function fetchSocialPosts() {
    const resultsDiv = document.getElementById('socialResults');
    resultsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-600 text-xl"></i></div>';
    
    try {
        const response = await fetch('/api/social/fetch-posts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days: 1 })
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultsDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
                        <div>
                            <p class="font-semibold text-green-800">Récupération réussie</p>
                            <p class="text-sm text-green-600">${data.posts_count} posts trouvés, ${data.saved_count} sauvegardés</p>
                        </div>
                    </div>
                </div>
            `;
            loadSocialStats();
        } else {
            resultsDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800">Erreur: ${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800">Erreur réseau: ${error.message}</p>
            </div>
        `;
    }
}

async function compareWithRSS() {
    const resultsDiv = document.getElementById('socialResults');
    resultsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-purple-600 text-xl"></i></div>';
    
    try {
        const response = await fetch('/api/social/compare', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days: 1 })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const summary = data.summary;
            resultsDiv.innerHTML = `
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h4 class="font-bold text-purple-800 mb-2">Comparaison terminée</h4>
                    <p class="text-sm text-purple-600">
                        Facteur Z: ${summary.factor_z.toFixed(3)} - ${summary.interpretation}
                    </p>
                </div>
            `;
            loadSocialStats();
        } else {
            resultsDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800">Erreur: ${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800">Erreur réseau: ${error.message}</p>
            </div>
        `;
    }
}

// Charger les statistiques au démarrage
async function loadSocialStats() {
    try {
        const response = await fetch('/api/social/statistics?days=7');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.statistics;
            document.getElementById('socialTotalPosts').textContent = stats.total_posts || 0;
            document.getElementById('socialPositivePosts').textContent = stats.sentiment_distribution?.positive || 0;
        }
        
        // Charger le Facteur Z
        const compResponse = await fetch('/api/social/comparison-history?limit=1');
        const compData = await compResponse.json();
        
        if (compData.success && compData.history && compData.history.length > 0) {
            document.getElementById('socialFactorZ').textContent = compData.history[0].factor_z.toFixed(2);
        }
    } catch (error) {
        console.error('Erreur chargement stats sociales:', error);
    }
}

// Charger les stats au démarrage
document.addEventListener('DOMContentLoaded', function() {
    loadSocialStats();
    console.log('✅ Page sociale initialisée');
});
</script>
{% endblock %}